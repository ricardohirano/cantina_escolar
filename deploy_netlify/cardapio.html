<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Card√°pio P√∫blico</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- CSS geral + CSS de card√°pio -->
  <link rel="stylesheet" href="static/css/style.css" />
  <link rel="stylesheet" href="static/css/stylecardapio.css" />
</head>

<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top bg-gradient-vinho shadow-sm">
    <div class="container-fluid px-4">
      <a class="navbar-brand fw-bold text-white" href="index.html">Cantina SENAI Registro</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link active" href="cardapio.html">Card√°pio</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- CONTE√öDO -->
  <main class="container mt-4">
    <div class="cartao-branco p-4 rounded shadow-sm">

      <h1 class="titulo-elegante mb-3 text-center">Card√°pio da Cantina</h1>
      <p class="text-muted mb-4 text-center">Confira as op√ß√µes dispon√≠veis hoje.</p>

      <!-- BOT√ïES DE CATEGORIA -->
      <div class="categoria-nav text-center mb-4">
        <a href="#" class="btn-categoria" data-cat="Bebidas">Bebidas</a>
        <a href="#" class="btn-categoria" data-cat="Sobremesas">Sobremesas</a>
        <a href="#" class="btn-categoria" data-cat="Salgados">Salgados</a>
        <a href="#" class="btn-categoria" data-cat="Refeicoes">Refei√ß√µes</a>
        <a href="#" class="btn-categoria" data-cat="Sorvetes">Sorvetes</a>
        <a href="#" class="btn-categoria" data-cat="Outros">Outros</a>
        <a href="#" class="btn-categoria" data-cat="Todas">Todas</a>
      </div>

      <!-- AQUI ENTRA O CARD√ÅPIO -->
      <section id="secao-cardapio" class="mt-3"></section>

      <!-- QR CODE -->
      <section class="qr-section text-center mt-4">
        <p class="text-muted small mb-2">Aponte a c√¢mera do celular</p>
        <img id="qr-img" src="static/img/qrcode.png" width="150" height="150" style="object-fit:contain;">
      </section>

    </div>
  </main>

  <footer class="border-top py-3 mt-4 text-center text-muted small">
    ¬© <span id="year"></span> Cantina Senai Registro
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>

  <!-- SCRIPT DO CARD√ÅPIO -->
  <script>
  // üîπ MODO DESENVOLVIMENTO LOCAL:
  // Quando for pro Netlify, troque por:
  //  const API_URL = "https://logincantina.onrender.com/api/cardapio";
  //  const IMG_BASE = "https://logincantina.onrender.com";
  const API_URL = "http://127.0.0.1:5000/api/cardapio";
  const IMG_BASE = "http://127.0.0.1:5000";
  const LIMITE_INICIAL = 4;  // quantos produtos mostrar antes do "Ver mais"

  function slugCategoria(nome) {
    return nome.normalize("NFD")
               .replace(/[\u0300-\u036f]/g, "")
               .toLowerCase();
  }

  async function carregarCardapio(filtro = null) {
    const container = document.getElementById("secao-cardapio");
    container.innerHTML = "<p class='text-muted'>Carregando card√°pio...</p>";

    try {
      const resposta = await fetch(API_URL);
      if (!resposta.ok) throw new Error("HTTP " + resposta.status);

      const dados = await resposta.json();
      container.innerHTML = "";

      const filtroNormal = filtro ? slugCategoria(filtro) : null;

      dados.categorias.forEach(cat => {
        const nomeNormal = slugCategoria(cat.nome);

        // Se tiver filtro, s√≥ mostra a categoria escolhida
        if (filtroNormal && nomeNormal !== filtroNormal) return;

        const produtos = cat.produtos;
        const temMuitos = produtos.length > LIMITE_INICIAL;

        const visiveis = produtos.slice(0, LIMITE_INICIAL);

        const cards = visiveis.map(p => `
          <div class="col">
            <div class="card-produto shadow-sm">
              <div class="img-wrapper">
                <img src="${IMG_BASE}${p.imagem}" class="img-produto" alt="${p.nome}">
              </div>
              <div class="p-2">
                <h6 class="card-title">${p.nome}</h6>
                <p class="card-text">${p.descricao || ""}</p>
                <p class="preco">R$ ${p.preco.toFixed(2)}</p>
              </div>
            </div>
          </div>
        `).join("");

        container.innerHTML += `
          <h5 class="categoria-titulo">${cat.nome}</h5>
          <div class="row row-cols-2 row-cols-md-4 g-3" id="cat-row-${nomeNormal}">
            ${cards}
          </div>
          ${temMuitos ? `
            <div class="text-center mt-2">
              <button class="btn-ver-mais" data-cat="${cat.nome}" data-aberto="0">
                Ver mais
              </button>
            </div>
          ` : ""}
        `;
      });

      if (!container.innerHTML.trim()) {
        container.innerHTML = "<p class='text-muted'>Nenhum produto encontrado.</p>";
      }

      ativarBotoesMais();

    } catch (erro) {
      console.error("Erro ao carregar card√°pio:", erro);
      container.innerHTML = "<p class='text-danger'>Erro ao carregar o card√°pio. Veja o console (F12).</p>";
    }
  }

  function ativarBotoesMais() {
    document.querySelectorAll(".btn-ver-mais").forEach(botao => {
      botao.addEventListener("click", async () => {
        const nomeCategoria = botao.dataset.cat;
        const slug = slugCategoria(nomeCategoria);
        const linha = document.getElementById(`cat-row-${slug}`);
        const aberto = botao.dataset.aberto === "1";

        try {
          const resposta = await fetch(API_URL);
          if (!resposta.ok) throw new Error("HTTP " + resposta.status);
          const dados = await resposta.json();

          const catObj = dados.categorias.find(c => slugCategoria(c.nome) === slug);
          if (!catObj) return;

          const produtos = catObj.produtos;
          const lista = aberto ? produtos.slice(0, LIMITE_INICIAL) : produtos;

          linha.innerHTML = lista.map(p => `
            <div class="col">
              <div class="card-produto shadow-sm">
                <div class="img-wrapper">
                  <img src="${IMG_BASE}${p.imagem}" class="img-produto" alt="${p.nome}">
                </div>
                <div class="p-2">
                  <h6 class="card-title">${p.nome}</h6>
                  <p class="card-text">${p.descricao || ""}</p>
                  <p class="preco">R$ ${p.preco.toFixed(2)}</p>
                </div>
              </div>
            </div>
          `).join("");

          if (aberto) {
            botao.textContent = "Ver mais";
            botao.dataset.aberto = "0";
          } else {
            botao.textContent = "Ver menos";
            botao.dataset.aberto = "1";
          }

        } catch (erro) {
          console.error("Erro ao alternar lista:", erro);
        }
      });
    });
  }

  // carrega tudo ao abrir
  carregarCardapio();

  // filtro pelos bot√µes de categoria
  document.querySelectorAll(".btn-categoria").forEach(btn => {
    btn.addEventListener("click", ev => {
      ev.preventDefault();
      const cat = btn.dataset.cat;
      carregarCardapio(cat === "Todas" ? null : cat);
      document.getElementById("secao-cardapio").scrollIntoView({ behavior: "smooth" });
    });
  });
</script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
